<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groupthink Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body class="bg-gray-950 text-white">
    <div id="app"></div>

    <script>
        let peer, hostId, myRole, connections = {}, gameActive = false;
        
        const roles = [
            {id:'boss', name:'Boss', color:'bg-red-600', emoji:'üëë'},
            {id:'sarah', name:'Sarah', color:'bg-purple-600', emoji:'ü§ù'},
            {id:'mike', name:'Mike', color:'bg-orange-600', emoji:'üõ°Ô∏è'},
            {id:'jen', name:'Jen', color:'bg-teal-600', emoji:'üòä'},
            {id:'alex', name:'Alex', color:'bg-blue-600', emoji:'üß†'}
        ];
        
        const dialogue = [
            {role:'boss', text:"Team, I've had a vision. Sitting is the new smoking. I propose we remove ALL office chairs."},
            {role:'sarah', text:"Brilliant! Standing desks boost productivity!"},
            {role:'alex', text:"But research shows standing all day causes serious health issues."},
            {role:'mike', text:"Alex, we need innovators, not naysayers!"},
            {role:'jen', text:"The boss usually knows what's best..."},
            {role:'alex', text:"What about employees with disabilities?"},
            {role:'boss', text:"We'll make exceptions. Standing is the default."},
            {role:'sarah', text:"Alex, trust the leadership!"},
            {role:'mike', text:"If you're not on board, you're not a team player."},
            {role:'alex', text:"I just think we should research more‚Äî"},
            {role:'jen', text:"Actually, I'm starting to see the vision."},
            {role:'boss', text:"Alex, are you with us or not?"},
            {role:'alex', text:"Fine... if everyone thinks it's a good idea..."},
            {role:'sarah', text:"Unanimous! This will revolutionize our workplace!"},
            {role:'mike', text:"Glad we're aligned."},
            {role:'alex', text:"*stays silent*"}
        ];
        
        function init() {
            const params = new URLSearchParams(location.search);
            if (params.get('mode') === 'student' && params.get('host') && params.get('role')) {
                initStudent(params.get('host'), params.get('role'));
            } else {
                showStart();
            }
        }
        
        function showStart() {
            app.innerHTML = `
                <div class="flex items-center justify-center min-h-screen p-4">
                    <button onclick="startHost()" class="bg-blue-600 hover:bg-blue-500 p-12 rounded-3xl transition-all hover:scale-105 shadow-2xl">
                        <div class="text-6xl mb-4">üë•</div>
                        <h1 class="text-4xl font-bold mb-3">Start Classroom</h1>
                        <p class="text-blue-200">Students join via QR codes</p>
                    </button>
                </div>
            `;
        }
        
        function startHost() {
            // Show QR codes IMMEDIATELY, don't wait for PeerJS
            hostId = 'temp-' + Math.random().toString(36).substr(2, 9);
            showLobby();
            
            // Try to initialize PeerJS in background
            try {
                peer = new Peer();
                peer.on('open', id => {
                    hostId = id;
                    console.log('PeerJS connected:', id);
                    updateQRCodes();
                });
                peer.on('connection', conn => {
                    connections[conn.metadata.role] = conn;
                    conn.on('open', updateStatus);
                });
                peer.on('error', err => {
                    console.error('PeerJS error (continuing anyway):', err);
                });
            } catch(e) {
                console.error('PeerJS failed (continuing anyway):', e);
            }
        }
        
        function showLobby() {
            const url = location.href.split('?')[0];
            app.innerHTML = `
                <div class="p-4 max-w-6xl mx-auto">
                    <h1 class="text-4xl font-bold text-center mb-2">Scan QR Codes to Join</h1>
                    <p class="text-center text-gray-400 mb-6">Room ID: <span id="roomId" class="text-blue-400 font-mono">${hostId}</span></p>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-6 mb-8">
                        ${roles.map(r => `
                            <div id="card-${r.id}" class="bg-gray-900 p-4 rounded-xl border-2 border-gray-700 text-center">
                                <canvas id="qr-${r.id}" class="bg-white p-2 rounded mb-3 w-full"></canvas>
                                <div class="${r.color} w-12 h-12 rounded-full mx-auto flex items-center justify-center text-2xl mb-2">${r.emoji}</div>
                                <h3 class="font-bold">${r.name}</h3>
                                <div class="status-${r.id} text-xs mt-2 text-gray-500">Waiting...</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="text-center">
                        <button onclick="startSim()" class="px-16 py-6 bg-green-600 hover:bg-green-500 font-bold text-2xl rounded-2xl">‚ñ∂ START</button>
                        <p class="text-gray-500 text-sm mt-3">You can start even without students connected</p>
                    </div>
                </div>
            `;
            generateQRCodes(url);
        }
        
        function generateQRCodes(url) {
            roles.forEach(r => {
                const canvas = document.getElementById(`qr-${r.id}`);
                if (canvas) {
                    QRCode.toCanvas(canvas, `${url}?mode=student&host=${hostId}&role=${r.id}`, {width: 200}, err => {
                        if (err) console.error('QR error:', err);
                    });
                }
            });
        }
        
        function updateQRCodes() {
            document.getElementById('roomId').textContent = hostId;
            const url = location.href.split('?')[0];
            generateQRCodes(url);
        }
        
        function updateStatus() {
            roles.forEach(r => {
                if (connections[r.id]?.open) {
                    document.querySelector(`.status-${r.id}`).textContent = '‚úì Ready';
                    document.getElementById(`card-${r.id}`).className = document.getElementById(`card-${r.id}`).className.replace('gray-700', 'green-500');
                }
            });
        }
        
        function initStudent(host, roleId) {
            myRole = roles.find(r => r.id === roleId);
            app.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen text-center p-6">
                    <div class="${myRole.color} w-28 h-28 rounded-full flex items-center justify-center text-5xl mb-6">${myRole.emoji}</div>
                    <h1 class="text-5xl font-bold mb-4">${myRole.name}</h1>
                    <div class="mt-8 text-yellow-500">Connecting to host: ${host}...</div>
                </div>
            `;
            
            try {
                peer = new Peer();
                peer.on('open', () => {
                    const conn = peer.connect(host, {metadata: {role: roleId}});
                    conn.on('open', () => {
                        app.innerHTML = app.innerHTML.replace('Connecting', '‚úì Connected! Waiting for simulation');
                    });
                    conn.on('data', data => {
                        if (data.type === 'yourTurn') showTurn(data.text);
                        else if (data.type === 'otherTurn') showListen(data.speaker, data.text);
                        else if (data.type === 'gameEnd') app.innerHTML = '<div class="flex items-center justify-center min-h-screen text-center"><h1 class="text-4xl font-bold">‚úì Complete!</h1></div>';
                    });
                    conn.on('error', err => {
                        app.innerHTML += '<p class="text-red-400 mt-4">Connection error: ' + err + '</p>';
                    });
                });
                peer.on('error', err => {
                    app.innerHTML += '<p class="text-red-400 mt-4">Failed to connect: ' + err + '</p>';
                });
            } catch(e) {
                app.innerHTML += '<p class="text-red-400 mt-4">Error: ' + e + '</p>';
            }
        }
        
        function showTurn(text) {
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            app.innerHTML = `
                <div class="flex flex-col min-h-screen bg-green-900">
                    <div class="p-4 bg-black/30 flex justify-between border-b-4 border-green-400">
                        <div class="flex items-center gap-2">
                            <div class="${myRole.color} w-10 h-10 rounded-full flex items-center justify-center text-xl">${myRole.emoji}</div>
                            <span class="font-bold">${myRole.name}</span>
                        </div>
                        <span class="bg-red-600 px-3 py-1 rounded-full text-xs font-bold animate-pulse">‚óè LIVE</span>
                    </div>
                    <div class="flex-1 flex items-center justify-center p-6">
                        <div class="text-center max-w-3xl">
                            <h2 class="text-green-300 text-4xl font-bold mb-8 animate-pulse">YOUR TURN!</h2>
                            <div class="bg-white text-black p-8 rounded-3xl border-8 border-green-400">
                                <p class="text-xs text-gray-600 uppercase mb-3">READ ALOUD:</p>
                                <p class="text-3xl font-bold leading-relaxed">"${text}"</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function showListen(speaker, text) {
            app.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen p-6 text-center">
                    <div class="opacity-50 mb-8">
                        <div class="${myRole.color} w-20 h-20 rounded-full flex items-center justify-center text-3xl mb-4 mx-auto">${myRole.emoji}</div>
                        <p class="text-gray-500">${myRole.name}</p>
                    </div>
                    <p class="text-gray-400 text-xs uppercase mb-4">LISTEN...</p>
                    <div class="bg-gray-900 p-6 rounded-2xl border-2 border-blue-600 max-w-2xl">
                        <p class="text-blue-400 font-bold mb-2">${speaker} is speaking:</p>
                        <p class="text-gray-300 text-xl italic">"${text}"</p>
                    </div>
                </div>
            `;
        }
        
        async function startSim() {
            gameActive = true;
            app.innerHTML = `
                <div class="p-4 max-w-7xl mx-auto">
                    <div class="flex justify-between mb-6">
                        <div>
                            <h1 class="text-3xl font-bold">Simulation Running</h1>
                            <p class="text-gray-400">Round <span id="round">0</span>/16</p>
                        </div>
                        <button onclick="location.reload()" class="px-6 py-3 bg-red-900 rounded-lg font-bold">STOP</button>
                    </div>
                    <div class="bg-gray-900 rounded-xl p-4 border border-gray-700 mb-4">
                        <h3 class="font-bold mb-2">Scenario:</h3>
                        <p class="text-gray-300 text-sm">Boss proposes removing ALL office chairs to "boost productivity"</p>
                    </div>
                    <div id="chat" class="bg-gray-900 rounded-xl p-4 border border-gray-700 min-h-[500px] max-h-[600px] overflow-y-auto"></div>
                </div>
            `;
            
            for (let i = 0; i < dialogue.length && gameActive; i++) {
                const line = dialogue[i];
                document.getElementById('round').textContent = i + 1;
                addMsg(line.role, line.text);
                broadcast(line.role, line.text);
                await sleep(3000);
            }
            
            if (gameActive) {
                endGame();
                setTimeout(() => {
                    alert('‚úì Simulation Complete!\n\nDiscussion Questions:\n\n1. Did you feel pressure to conform?\n2. Was Alex\'s logic fairly considered?\n3. What groupthink symptoms did you observe?\n\n(Stereotyping dissenter, direct pressure, self-censorship, illusion of unanimity)');
                }, 1000);
            }
        }
        
        function addMsg(roleId, text) {
            const role = roles.find(r => r.id === roleId);
            const msg = document.createElement('div');
            msg.className = 'mb-4 opacity-0 transition-opacity duration-300';
            msg.innerHTML = `
                <div class="bg-gray-800 p-4 rounded-2xl border border-gray-700">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="${role.color} w-8 h-8 rounded-full flex items-center justify-center text-lg">${role.emoji}</span>
                        <span class="text-xs text-gray-400 font-bold uppercase">${role.name}</span>
                    </div>
                    <p class="text-gray-200 text-lg leading-relaxed">${text}</p>
                </div>
            `;
            chat.appendChild(msg);
            setTimeout(() => msg.classList.remove('opacity-0'), 10);
            chat.scrollTop = chat.scrollHeight;
        }
        
        function broadcast(roleId, text) {
            if (connections[roleId]?.open) {
                connections[roleId].send({type: 'yourTurn', text: text});
            }
            roles.forEach(r => {
                if (r.id !== roleId && connections[r.id]?.open) {
                    connections[r.id].send({
                        type: 'otherTurn',
                        speaker: roles.find(x => x.id === roleId).name,
                        text: text
                    });
                }
            });
        }
        
        function endGame() {
            Object.values(connections).forEach(conn => {
                if (conn?.open) conn.send({type: 'gameEnd'});
            });
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        window.onload = init;
    </script>
</body>
</html>