<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groupthink Classroom Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body class="bg-gray-950 text-white min-h-screen">
    <div id="app"></div>

    <script>
        // ==================== CONFIGURATION ====================
        const GEMINI_API_KEY = 'YOUR_API_KEY_HERE'; // <-- PUT YOUR API KEY HERE
        
        // ==================== STATE ====================
        let mode = null; // 'host' or 'student'
        let peer = null;
        let hostId = null;
        let myRole = null;
        let connections = {};
        let messages = [];
        let gameActive = false;

        const roles = [
            { id: 'boss', name: 'Boss', color: 'bg-red-600', emoji: 'üëë' },
            { id: 'sarah', name: 'Sarah (Yes-Man)', color: 'bg-purple-600', emoji: 'ü§ù' },
            { id: 'mike', name: 'Mike (Enforcer)', color: 'bg-orange-600', emoji: 'üõ°Ô∏è' },
            { id: 'jen', name: 'Jen (Follower)', color: 'bg-teal-600', emoji: 'üòä' },
            { id: 'alex', name: 'Alex (Dissenter)', color: 'bg-blue-600', emoji: 'üß†' }
        ];

        // ==================== INIT ====================
        function init() {
            const params = new URLSearchParams(window.location.search);
            const studentMode = params.get('mode') === 'student';
            const studentHost = params.get('host');
            const studentRole = params.get('role');

            if (studentMode && studentHost && studentRole) {
                initStudent(studentHost, studentRole);
            } else {
                showModeSelection();
            }
        }

        // ==================== MODE SELECTION ====================
        function showModeSelection() {
            document.getElementById('app').innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen p-4">
                    <h1 class="text-5xl font-bold mb-8 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                        Groupthink Simulator
                    </h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl w-full">
                        <button onclick="startHost()" class="bg-gradient-to-br from-blue-600 to-blue-800 hover:from-blue-500 hover:to-blue-700 p-8 rounded-2xl transition-all hover:scale-105 shadow-xl">
                            <div class="text-4xl mb-4">üë•</div>
                            <h2 class="text-2xl font-bold mb-2">Classroom Mode</h2>
                            <p class="text-blue-200">Host a simulation with students on their phones</p>
                        </button>
                        <button onclick="startObserver()" class="bg-gradient-to-br from-purple-600 to-purple-800 hover:from-purple-500 hover:to-purple-700 p-8 rounded-2xl transition-all hover:scale-105 shadow-xl">
                            <div class="text-4xl mb-4">üëÅÔ∏è</div>
                            <h2 class="text-2xl font-bold mb-2">Observer Mode</h2>
                            <p class="text-purple-200">Watch AI agents demonstrate groupthink</p>
                        </button>
                    </div>
                </div>
            `;
        }

        // ==================== HOST MODE ====================
        async function startHost() {
            mode = 'host';
            document.getElementById('app').innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen p-4">
                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-500 border-t-transparent mb-4"></div>
                    <p class="text-xl text-gray-400">Initializing classroom...</p>
                </div>
            `;

            try {
                peer = new Peer();
                
                peer.on('open', (id) => {
                    hostId = id;
                    console.log('Host ID:', id);
                    showHostLobby();
                });

                peer.on('connection', (conn) => {
                    console.log('Student connected:', conn.metadata.role);
                    connections[conn.metadata.role] = conn;
                    
                    conn.on('data', (data) => {
                        console.log('Received from student:', data);
                    });

                    updateConnectionStatus();
                });

                peer.on('error', (err) => {
                    console.error('PeerJS error:', err);
                    alert('Failed to initialize: ' + err.message);
                });

            } catch (error) {
                console.error('Failed to start host:', error);
                alert('Failed to start host mode. Please refresh and try again.');
            }
        }

        function showHostLobby() {
            const baseUrl = window.location.origin + window.location.pathname;
            
            document.getElementById('app').innerHTML = `
                <div class="p-4 max-w-7xl mx-auto">
                    <div class="mb-8 text-center">
                        <h1 class="text-4xl font-bold mb-2">Classroom Setup</h1>
                        <p class="text-gray-400 mb-4">Students scan QR codes to join as different roles</p>
                        <div class="inline-flex items-center gap-4 bg-gray-900 px-6 py-3 rounded-full border border-gray-700">
                            <span class="text-gray-500 text-sm">Room ID:</span>
                            <span class="font-mono text-xl text-blue-400 font-bold">${hostId}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-8" id="roleCards">
                        ${roles.map(role => `
                            <div class="bg-gray-900 p-4 rounded-xl border-2 border-gray-700 flex flex-col items-center" id="card-${role.id}">
                                <div class="bg-white p-3 rounded-lg mb-4 w-full aspect-square flex items-center justify-center">
                                    <canvas id="qr-${role.id}"></canvas>
                                </div>
                                <div class="${role.color} w-12 h-12 rounded-full flex items-center justify-center text-2xl mb-2">
                                    ${role.emoji}
                                </div>
                                <h3 class="font-bold mb-1">${role.name}</h3>
                                <div class="status-${role.id} px-3 py-1 rounded-full text-xs font-bold bg-gray-800 text-gray-500">
                                    <span class="inline-block w-2 h-2 rounded-full bg-gray-600 mr-2"></span>
                                    Waiting...
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="text-center">
                        <button onclick="startSimulation()" class="px-10 py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold text-xl rounded-2xl shadow-xl transition-all transform hover:scale-105">
                            Start Simulation
                        </button>
                    </div>
                </div>
            `;

            // Generate QR codes
            setTimeout(() => {
                roles.forEach(role => {
                    const url = `${baseUrl}?mode=student&host=${hostId}&role=${role.id}`;
                    const canvas = document.getElementById(`qr-${role.id}`);
                    if (canvas) {
                        QRCode.toCanvas(canvas, url, { width: 200, margin: 1 }, (error) => {
                            if (error) console.error('QR generation error:', error);
                        });
                    }
                });
            }, 100);
        }

        function updateConnectionStatus() {
            roles.forEach(role => {
                const statusEl = document.querySelector(`.status-${role.id}`);
                const cardEl = document.getElementById(`card-${role.id}`);
                if (statusEl && cardEl) {
                    if (connections[role.id]) {
                        statusEl.innerHTML = '<span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></span>Ready!';
                        statusEl.className = `status-${role.id} px-3 py-1 rounded-full text-xs font-bold bg-green-900 text-green-400`;
                        cardEl.className = cardEl.className.replace('border-gray-700', 'border-green-500');
                    }
                }
            });
        }

        // ==================== STUDENT MODE ====================
        function initStudent(hostPeerId, roleId) {
            mode = 'student';
            myRole = roles.find(r => r.id === roleId);
            
            document.getElementById('app').innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen p-6 text-center">
                    <div class="${myRole.color} w-24 h-24 rounded-full flex items-center justify-center text-4xl mb-6 shadow-lg">
                        ${myRole.emoji}
                    </div>
                    <h2 class="text-gray-400 uppercase text-sm font-bold tracking-widest mb-2">You are playing</h2>
                    <h1 class="text-4xl font-bold mb-8">${myRole.name}</h1>
                    <div class="flex items-center gap-3 bg-gray-900 px-6 py-3 rounded-full border border-gray-800">
                        <div class="w-3 h-3 bg-yellow-500 rounded-full animate-bounce"></div>
                        <span class="text-gray-400 animate-pulse">Connecting to host...</span>
                    </div>
                </div>
            `;

            try {
                peer = new Peer();
                
                peer.on('open', (id) => {
                    console.log('Student peer ID:', id);
                    const conn = peer.connect(hostPeerId, { metadata: { role: roleId } });
                    
                    conn.on('open', () => {
                        console.log('Connected to host');
                        showStudentWaiting();
                    });

                    conn.on('data', (data) => {
                        console.log('Received from host:', data);
                        if (data.type === 'message' && data.roleId === roleId) {
                            showStudentMessage(data.text);
                        } else if (data.type === 'gameEnd') {
                            showStudentEnd();
                        }
                    });

                    conn.on('error', (err) => {
                        console.error('Connection error:', err);
                        alert('Failed to connect to host: ' + err.message);
                    });
                });

                peer.on('error', (err) => {
                    console.error('Student peer error:', err);
                    alert('Connection failed: ' + err.message);
                });

            } catch (error) {
                console.error('Failed to connect as student:', error);
                alert('Failed to connect. Please try scanning the QR code again.');
            }
        }

        function showStudentWaiting() {
            document.getElementById('app').innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen p-6 text-center">
                    <div class="${myRole.color} w-24 h-24 rounded-full flex items-center justify-center text-4xl mb-6 shadow-lg">
                        ${myRole.emoji}
                    </div>
                    <h1 class="text-4xl font-bold mb-8">${myRole.name}</h1>
                    <div class="flex items-center gap-3 bg-gray-900 px-6 py-3 rounded-full border border-gray-800">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-gray-400">Waiting for simulation to start...</span>
                    </div>
                </div>
            `;
        }

        function showStudentMessage(text) {
            document.getElementById('app').innerHTML = `
                <div class="flex flex-col min-h-screen bg-green-900">
                    <div class="p-4 bg-black/20 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="${myRole.color} w-8 h-8 rounded-full flex items-center justify-center text-lg">
                                ${myRole.emoji}
                            </div>
                            <span class="font-bold">${myRole.name}</span>
                        </div>
                        <span class="bg-red-600 text-white text-xs font-bold px-2 py-1 rounded animate-pulse">YOUR TURN</span>
                    </div>
                    <div class="flex-1 flex flex-col items-center justify-center p-6 text-center">
                        <h2 class="text-green-300 font-black text-2xl uppercase tracking-widest mb-6 animate-pulse">
                            YOUR TURN TO SPEAK!
                        </h2>
                        <div class="bg-white text-black p-8 rounded-2xl shadow-2xl border-4 border-green-400 max-w-2xl">
                            <p class="text-xs text-gray-500 uppercase font-bold mb-2">Read this aloud:</p>
                            <p class="text-3xl font-bold leading-relaxed">"${text}"</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function showStudentEnd() {
            document.getElementById('app').innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen p-6 text-center">
                    <div class="text-6xl mb-6">‚úÖ</div>
                    <h1 class="text-3xl font-bold mb-4">Simulation Complete</h1>
                    <p class="text-gray-400">Thank you for participating!</p>
                </div>
            `;
        }

        // ==================== SIMULATION ====================
        async function startSimulation() {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_API_KEY_HERE') {
                alert('Please set your Gemini API key in the HTML file first!');
                return;
            }

            gameActive = true;
            
            // Switch to game view
            document.getElementById('app').innerHTML = `
                <div class="p-4 max-w-7xl mx-auto">
                    <div class="mb-8">
                        <h1 class="text-4xl font-bold mb-2">Simulation Running</h1>
                        <div class="flex items-center gap-3 bg-gray-900 px-4 py-2 rounded-lg">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <span class="text-gray-400">Round <span id="round">1</span> / 5</span>
                            <button onclick="stopSimulation()" class="ml-auto px-4 py-2 bg-red-900 hover:bg-red-800 rounded text-sm font-bold">
                                Stop
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="md:col-span-3">
                            <div class="bg-gray-900 rounded-2xl p-8 border border-gray-800 mb-6">
                                <div class="flex justify-around flex-wrap gap-8" id="avatars">
                                    ${roles.map(role => `
                                        <div class="flex flex-col items-center" id="avatar-${role.id}">
                                            <div class="${role.color} w-16 h-16 rounded-full flex items-center justify-center text-2xl border-4 border-gray-700 transition-all">
                                                ${role.emoji}
                                            </div>
                                            <span class="mt-2 text-sm text-gray-400">${role.name.split('(')[0].trim()}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="bg-gray-900 rounded-xl p-4 border border-gray-700 min-h-[400px] max-h-[500px] overflow-y-auto" id="chat">
                                <!-- Messages will appear here -->
                            </div>
                        </div>
                        
                        <div class="md:col-span-1">
                            <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 mb-6">
                                <h4 class="font-bold text-sm uppercase mb-4 border-b border-gray-700 pb-2">Scenario</h4>
                                <p class="text-sm text-gray-300">The boss proposes removing all office chairs to "boost productivity"</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Run simulation
            await runSimulationLoop();
        }

        async function runSimulationLoop() {
            const scenario = {
                badIdea: "remove all office chairs and make everyone stand",
                opening: "Team, I've had a vision. Sitting is the new smoking. I propose we remove all chairs."
            };

            addMessage('boss', scenario.opening);
            broadcast('boss', scenario.opening);

            for (let round = 1; round <= 5 && gameActive; round++) {
                document.getElementById('round').textContent = round;
                await sleep(3000);

                // Simulate AI responses (simplified - you'd call Gemini API here)
                const responses = generateResponses(round);
                
                for (const response of responses) {
                    if (!gameActive) break;
                    highlightSpeaker(response.role);
                    addMessage(response.role, response.text);
                    broadcast(response.role, response.text);
                    await sleep(2000);
                    unhighlightSpeaker(response.role);
                }
            }

            // End game
            broadcastGameEnd();
            setTimeout(() => {
                alert('Simulation complete! Discussion questions:\n\n1. Did you feel pressure to conform?\n2. Was the dissenter given fair consideration?\n3. What groupthink symptoms did you notice?');
                location.reload();
            }, 2000);
        }

        function generateResponses(round) {
            // Simplified responses - in real version, call Gemini API
            const responses = [
                [
                    { role: 'sarah', text: "Brilliant idea! Standing desks are the future!" },
                    { role: 'alex', text: "Wait, but studies show standing all day causes health problems..." },
                    { role: 'mike', text: "Alex, we need to think innovatively here!" }
                ],
                [
                    { role: 'jen', text: "I think the boss has a point about productivity..." },
                    { role: 'alex', text: "What about employees with disabilities or injuries?" },
                    { role: 'boss', text: "We'll make exceptions, but this is the direction we're going." }
                ],
                [
                    { role: 'sarah', text: "Alex, you're being too negative. Trust the leadership!" },
                    { role: 'mike', text: "Yeah, if you're not on board, maybe you're not a team player." },
                    { role: 'alex', text: "I... I just think we should consider the risks..." }
                ],
                [
                    { role: 'jen', text: "Actually, I'm starting to see the vision." },
                    { role: 'alex', text: "Fine. Maybe you're right. Let's do it." },
                    { role: 'boss', text: "Excellent! Unanimous decision. I'll order the removals." }
                ],
                [
                    { role: 'sarah', text: "This is going to revolutionize our workplace!" },
                    { role: 'mike', text: "Glad we're all aligned on this." },
                    { role: 'alex', text: "*stays silent*" }
                ]
            ];
            
            return responses[Math.min(round - 1, responses.length - 1)];
        }

        function addMessage(roleId, text) {
            const role = roles.find(r => r.id === roleId);
            const chat = document.getElementById('chat');
            if (chat) {
                const msg = document.createElement('div');
                msg.className = 'mb-4 animate-fadeIn';
                msg.innerHTML = `
                    <div class="bg-gray-800 p-4 rounded-2xl rounded-tl-none border border-gray-700">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="${role.color} w-6 h-6 rounded-full flex items-center justify-center text-sm">${role.emoji}</span>
                            <span class="text-xs text-gray-400 font-bold uppercase">${role.name}</span>
                        </div>
                        <p class="text-sm text-gray-200">${text}</p>
                    </div>
                `;
                chat.appendChild(msg);
                chat.scrollTop = chat.scrollHeight;
            }
        }

        function highlightSpeaker(roleId) {
            const avatar = document.getElementById(`avatar-${roleId}`);
            if (avatar) {
                const circle = avatar.querySelector('div');
                circle.className = circle.className.replace('border-gray-700', 'border-yellow-400 shadow-lg shadow-yellow-400/50 scale-110');
            }
        }

        function unhighlightSpeaker(roleId) {
            const avatar = document.getElementById(`avatar-${roleId}`);
            if (avatar) {
                const circle = avatar.querySelector('div');
                circle.className = circle.className.replace('border-yellow-400 shadow-lg shadow-yellow-400/50 scale-110', 'border-gray-700');
            }
        }

        function broadcast(roleId, text) {
            Object.values(connections).forEach(conn => {
                if (conn && conn.open) {
                    conn.send({ type: 'message', roleId, text });
                }
            });
        }

        function broadcastGameEnd() {
            Object.values(connections).forEach(conn => {
                if (conn && conn.open) {
                    conn.send({ type: 'gameEnd' });
                }
            });
        }

        function stopSimulation() {
            gameActive = false;
            location.reload();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ==================== OBSERVER MODE ====================
        function startObserver() {
            alert('Observer mode: Watch AI agents only (no students). Starting simulation...');
            mode = 'observer';
            startSimulation();
        }

        // ==================== START ====================
        init();
    </script>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</body>
</html>
